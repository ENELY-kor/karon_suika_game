<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ïπ¥Î°† Ïú†ÎãàÎ≤ÑÏä§ (ÏàòÎ∞ï)Í≤åÏûÑ</title>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #FFF5E1; font-family: 'Jua', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; touch-action: none; }
        .main-layout { display: flex; align-items: flex-start; gap: 20px; margin-top: 80px; }
        .guide-panel { width: 110px; height: 700px; background: rgba(255, 255, 255, 0.7); border-radius: 20px; padding: 15px 10px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 4px solid #FFD1DC; box-sizing: border-box; }
        .guide-title { color: #FF6B81; font-size: 1.1rem; margin-bottom: 15px; font-weight: bold; }
        .guide-list { display: flex; flex-direction: column-reverse; align-items: center; justify-content: space-between; flex: 1; width: 100%; }
        .guide-item { display: flex; align-items: center; justify-content: center; }
        .guide-circle { border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); box-shadow: 1px 1px 5px rgba(0,0,0,0.15); background-size: cover; background-position: center; background-repeat: no-repeat; background-color: #fff; }
        
        #game-wrapper { position: relative; width: 500px; height: 700px; }
        #cloud-player { position: absolute; top: -90px; left: 50%; width: 130px; height: 90px; transform: translateX(-50%); z-index: 20; pointer-events: none; }
        .cloud-shape { width: 100%; height: 100%; background-image: url('image/cloud.png'); background-size: contain; background-repeat: no-repeat; background-position: center bottom; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); }
        #next-fruit-preview { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; border: 3px solid #fff; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); z-index: 21; background-size: cover; background-position: center; background-repeat: no-repeat; background-color: #fff; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: #aaa; font-weight: bold; }
        
        #game-container { width: 100%; height: 100%; background: #ffffff; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); overflow: hidden; border: 8px solid #FFD1DC; position: relative; cursor: none; }
        
        #blind-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 15; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
        .blind-active { opacity: 0.95 !important; }
        #freeze-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 200, 255, 0.2); z-index: 14; pointer-events: none; opacity: 0; transition: opacity 0.5s; border: 5px solid #00C8FF; box-sizing: border-box; }
        .freeze-active { opacity: 1 !important; }

        .ui-header { 
            position: absolute; top: 20px; left: 0; width: 100%; 
            display: flex; justify-content: flex-end; align-items: center; 
            padding: 0 30px; box-sizing: border-box; z-index: 10; pointer-events: auto;
            gap: 10px;
        }
        .score-box { 
            background: rgba(255, 255, 255, 0.9); padding: 5px 20px; 
            border-radius: 50px; border: 3px solid #FF6B81; color: #FF6B81; 
            font-size: 1.5rem; box-shadow: 0 5px 10px rgba(0,0,0,0.1); 
            text-align: center; font-weight: bold; min-width: 80px;
            pointer-events: none;
        }
        
        .icon-btn {
            width: 50px; height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            border: 3px solid #FF6B81;
            color: #FF6B81;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.1s;
            outline: none;
        }
        .icon-btn:hover { transform: scale(1.05); }
        .icon-btn:active { transform: scale(0.95); }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 245, 225, 0.95); backdrop-filter: blur(8px); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 30; text-align: center; transition: opacity 0.3s; }
        .hidden { opacity: 0; pointer-events: none; }
        h1 { color: #FF6B81; font-size: 3.5rem; margin-bottom: 20px; text-shadow: 3px 3px 0 #fff; }
        .bouncy-btn { padding: 15px 40px; margin: 10px; font-size: 1.4rem; font-family: 'Jua', sans-serif; border: none; border-radius: 50px; cursor: pointer; color: white; box-shadow: 0 8px 15px rgba(0,0,0,0.1); transition: all 0.2s; }
        .bouncy-btn:hover { transform: scale(1.05) translateY(-3px); }
        .btn-easy { background: linear-gradient(45deg, #4ECDC4, #2BCBBA); }
        .btn-vanilla { background: linear-gradient(45deg, #FFD32A, #FFA502); color: #555; }
        .btn-hard { background: linear-gradient(45deg, #FF6B81, #FF4757); }
        .jelly-card { width: 320px; padding: 40px; background: white; border-radius: 35px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 6px solid; animation: rubberBand 0.8s both; }
        .card-easy { border-color: #4ECDC4; }
        .card-hard { border-color: #FF6B81; }
        @keyframes rubberBand { 0% { transform: scale(1); } 30% { transform: scale(1.25, 0.75); } 40% { transform: scale(0.75, 1.25); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="main-layout">
        <div class="guide-panel">
            <div class="guide-title">ÏßÑÌôî Í≥ºÏ†ï</div>
            <div id="guide-list" class="guide-list"></div>
        </div>

        <div id="game-wrapper">
            <div id="cloud-player">
                <div class="cloud-shape"></div>
                <div id="next-fruit-preview"></div>
            </div>
            <div id="game-container">
                <div id="blind-layer"></div>
                <div id="freeze-layer"></div> 
                
                <div class="ui-header">
                    <div class="score-box">
                        <span style="font-size:0.7rem; display:block; opacity:0.8;">SCORE</span>
                        <span id="score-text">0</span>
                    </div>
                    <button id="sound-btn" class="icon-btn" onclick="toggleSound()">üîä</button>
                </div>

                <div id="start-screen" class="overlay">
                    <h1>Ïπ¥Î°† Ïú†ÎãàÎ≤ÑÏä§<br>ÏàòÎ∞ïÍ≤åÏûÑ</h1>
                    <p style="font-size: 1.3rem; color:#666; margin-bottom: 30px;">ÎÇúÏù¥ÎèÑÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!</p>
                    <div>
                        <button class="bouncy-btn btn-easy" onclick="startGame('easy')">Ïâ¨ÏõÄ</button>
                        <button class="bouncy-btn btn-vanilla" onclick="startGame('vanilla')">Ïò§Î¶¨ÏßÄÎÑê</button>
                        <button class="bouncy-btn btn-hard" onclick="startGame('hard')">Í∞úÏ≥ê Ïñ¥Î†§ÏõÄ</button>
                    </div>
                </div>
                <div id="card-screen" class="overlay hidden">
                    <div id="active-card" class="jelly-card">
                        <h2 id="card-title" style="font-size:2rem; margin:0;"></h2>
                        <p id="card-desc" style="font-size:1.4rem; margin:25px 0; line-height:1.5;"></p>
                        <button class="bouncy-btn btn-vanilla" onclick="applyCardEffect()" style="font-size:1.2rem; padding: 12px 30px;">ÌôïÏù∏!</button>
                    </div>
                </div>
                <div id="game-over-screen" class="overlay hidden">
                    <h1>Í≤åÏûÑ Ïò§Î≤Ñ!</h1>
                    <p id="final-mode" style="font-size:1.5rem; color:#555; margin-bottom: 5px;">-</p>
                    <p>ÏµúÏ¢Ö Ï†êÏàò</p>
                    <p id="final-score" style="font-size:2.5rem; color:#FF6B81; font-weight:bold; margin: 5px 0 30px 0;">0Ï†ê</p>
                    <button class="bouncy-btn btn-vanilla" onclick="location.reload()">Îã§Ïãú ÌïòÍ∏∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { Engine, Render, World, Bodies, Body, Events, Composite, Runner } = Matter;

        const WIDTH = 500;
        const HEIGHT = 700;
        
        let engine, render, runner;
        let currentMode = 'vanilla';
        let score = 0;
        let isGameOver = false;
        let nextFruitIndex = 0;
        let canDrop = true;
        const CARD_THRESHOLD = 100;
        let lastCardScore = 0;

        let isSoundOn = true;

        // üîä [ÏµúÏ†ÅÌôî] ÏÇ¨Ïö¥Îìú Í∞ùÏ≤¥ ÎØ∏Î¶¨ ÏÉùÏÑ± (DOM ÌÉêÏÉâ ÎπÑÏö© Ï†úÍ±∞)
        const soundMap = {
            drop: new Audio('sound/drop.mp3'),
            pop: new Audio('sound/pop.mp3')
        };
        // ÎØ∏Î¶¨ Î°úÎî©
        soundMap.drop.load();
        soundMap.pop.load();

        // üé≤ Ìö®Í≥º Î≥ÄÏàò
        let scoreMultiplier = 1.0; 
        let fixedSpawnCount = 0;   
        let blindFieldCount = 0;   
        let blindNextCount = 0;    
        let lowGravityCount = 0; 
        let freezeCount = 0; 
        let ghostCount = 0;  

        const BASE_IMAGE_SIZE = 4096; 
        const OPTIMIZED_SIZE = 256;

        const FRUITS = [
            { radius: 20, score: 2, img: "image/0.png" },
            { radius: 30, score: 4, img: "image/1.png" },
            { radius: 42, score: 6, img: "image/2.png" },
            { radius: 52, score: 8, img: "image/3.png" },
            { radius: 64, score: 10, img: "image/4.png" },
            { radius: 76, score: 12, img: "image/5.png" },
            { radius: 88, score: 14, img: "image/6.png" },
            { radius: 100, score: 16, img: "image/7.png" },
            { radius: 115, score: 18, img: "image/8.png" },
            { radius: 130, score: 20, img: "image/9.png" },
            { radius: 155, score: 22, img: "image/10.png" }
        ];

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('sound-btn');
            btn.innerText = isSoundOn ? 'üîä' : 'üîá';
        }

        // üîä [ÏµúÏ†ÅÌôî] ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù Ìï®Ïàò (Î†â Î∞©ÏßÄ Î≤ÑÏ†Ñ)
        function playSound(type) {
            if (!isSoundOn) return;
            
            // Í∏∞Ï°¥ Ïò§ÎîîÏò§Î•º Î≥µÏ†ú(clone)Ìï¥ÏÑú Ïû¨ÏÉù -> Í≤πÏπ® ÌóàÏö© & ÎîúÎ†àÏù¥ ÏµúÏÜåÌôî
            const soundToPlay = soundMap[type].cloneNode();
            
            // Î≥ºÎ•® Ï°∞Ï†à (ÎÑàÎ¨¥ ÏãúÎÅÑÎü¨Ïö∞Î©¥ Ïó¨Í∏∞ÏÑú Ï°∞Ï†à)
            soundToPlay.volume = 0.6; 

            soundToPlay.play().catch(e => {
                // ÏÇ¨Ïö©ÏûêÍ∞Ä ÌéòÏù¥ÏßÄÏôÄ ÏÉÅÌò∏ÏûëÏö©ÌïòÍ∏∞ Ï†ÑÏóêÎäî Ïû¨ÏÉùÏù¥ Ï∞®Îã®Îê† Ïàò ÏûàÏùå (Î∏åÎùºÏö∞Ï†Ä Ï†ïÏ±Ö)
                // console.log('ÏÇ¨Ïö¥Îìú Ïû¨ÏÉù Ïã§Ìå®:', e); 
            });
        }

        function preloadAndOptimizeImages() {
            FRUITS.forEach((fruit) => {
                const img = new Image();
                img.src = fruit.img;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = OPTIMIZED_SIZE;
                    canvas.height = OPTIMIZED_SIZE;
                    const ctx = canvas.getContext('2d');
                    ctx.filter = 'blur(0.5px)'; 
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, OPTIMIZED_SIZE, OPTIMIZED_SIZE);
                    fruit.optimizedImg = canvas.toDataURL('image/png');
                };
            });
        }

        window.onload = function() {
            preloadAndOptimizeImages();
            const guideList = document.getElementById('guide-list');
            FRUITS.forEach(fruit => {
                const item = document.createElement('div');
                item.className = 'guide-item';
                const size = Math.max(12, fruit.radius / 4.5); 
                item.innerHTML = `<div class="guide-circle" style="width:${size*2}px; height:${size*2}px; background-image: url('${fruit.img}');"></div>`;
                guideList.appendChild(item);
            });
        };

        function startGame(mode) {
            currentMode = mode;
            document.getElementById('start-screen').classList.add('hidden');
            initPhysics();
            setNextFruit();
            
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('touchmove', handleMouseMove, {passive: false});
            const wrapper = document.getElementById('game-wrapper');
            wrapper.addEventListener('pointerdown', handleInput);

            requestAnimationFrame(updateCloudPosition);
        }

        function initPhysics() {
            engine = Engine.create({ timing: { timeScale: 0.8 } });
            render = Render.create({
                element: document.getElementById('game-container'),
                engine: engine,
                options: { 
                    width: WIDTH, height: HEIGHT, 
                    wireframes: false, background: 'transparent', pixelRatio: 2 
                }
            });

            const wallOpt = { isStatic: true, render: { visible: false } };
            World.add(engine.world, [
                Bodies.rectangle(WIDTH/2, HEIGHT + 30, WIDTH, 60, wallOpt),
                Bodies.rectangle(-30, HEIGHT/2, 60, HEIGHT, wallOpt),
                Bodies.rectangle(WIDTH + 30, HEIGHT/2, 60, HEIGHT, wallOpt)
            ]);
            
            Events.on(engine, 'collisionStart', handleCollisions);
            Events.on(engine, 'afterUpdate', checkGameOverLogic);
            runner = Runner.create();
            Runner.run(runner, engine);
            Render.run(render);
        }

        let targetX = WIDTH / 2;
        let currentCloudX = WIDTH / 2;
        
        function handleMouseMove(e) {
            if(isGameOver) return;
            const wrapper = document.getElementById('game-wrapper');
            const rect = wrapper.getBoundingClientRect();
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let x = clientX - rect.left;
            const currentRadius = FRUITS[nextFruitIndex].radius;
            const limit = currentRadius + 15;
            targetX = Math.max(limit, Math.min(WIDTH - limit, x));
        }

        function updateCloudPosition() {
            if(isGameOver) return;
            currentCloudX += (targetX - currentCloudX) * 0.15;
            const cloud = document.getElementById('cloud-player');
            if(cloud) cloud.style.left = currentCloudX + 'px';
            requestAnimationFrame(updateCloudPosition);
        }

        function handleInput(e) {
            if (isGameOver || !canDrop) return;
            
            // üîä Ìà¨Ìïò ÏÜåÎ¶¨ Ïû¨ÏÉù
            playSound('drop');

            createFruit(currentCloudX, 30, nextFruitIndex, true);
            canDrop = false;

            if (fixedSpawnCount > 0) fixedSpawnCount--;
            if (blindNextCount > 0) blindNextCount--;
            if (blindFieldCount > 0) {
                blindFieldCount--;
                if(blindFieldCount === 0) document.getElementById('blind-layer').classList.remove('blind-active');
            }
            if (lowGravityCount > 0) {
                lowGravityCount--;
                if (lowGravityCount === 0) engine.world.gravity.y = 1; 
            }
            if (freezeCount > 0) {
                freezeCount--;
                if (freezeCount === 0) {
                    document.getElementById('freeze-layer').classList.remove('freeze-active');
                    const bodies = Composite.allBodies(engine.world).filter(b => b.label.startsWith('fruit_'));
                    bodies.forEach(b => { b.friction = 0.1; b.frictionStatic = 0.5; b.restitution = 0.3; });
                }
            }
            if (ghostCount > 0) ghostCount--;

            const preview = document.getElementById('next-fruit-preview');
            preview.style.transform = 'translate(-50%, 50%) scale(0.1)';
            preview.style.opacity = '0';

            setTimeout(() => { 
                canDrop = true; 
                setNextFruit();
                preview.style.transform = 'translate(-50%, -50%) scale(1)';
                preview.style.opacity = '1';
            }, 500);
        }

        function createFruit(x, y, index, isDropping = false) {
            const info = FRUITS[index];
            let renderTexture = info.img;        
            let currentBaseSize = BASE_IMAGE_SIZE; 
            if (info.optimizedImg) { renderTexture = info.optimizedImg; currentBaseSize = OPTIMIZED_SIZE; }
            const scale = (info.radius * 2) / currentBaseSize;

            let collisionMask = 0; 
            if (isDropping && ghostCount > 0) collisionMask = -1;

            const fruit = Bodies.circle(x, y, info.radius, {
                label: `fruit_${index}`, 
                restitution: 0.3, friction: 0.1, density: 0.001,
                render: { 
                    sprite: { texture: renderTexture, xScale: scale, yScale: scale },
                    opacity: (isDropping && ghostCount > 0) ? 0.5 : 1 
                },
                collisionFilter: { group: collisionMask }
            });
            
            if (isDropping && ghostCount === 0) {
                setTimeout(() => { fruit.collisionFilter.group = 0; }, 150);
            }
            
            if (freezeCount > 0) {
                fruit.friction = 1.0; fruit.frictionStatic = 10.0; fruit.restitution = 0.0;
            }

            World.add(engine.world, fruit);
        }

        function setNextFruit() {
            const preview = document.getElementById('next-fruit-preview');
            
            if (fixedSpawnCount > 0) nextFruitIndex = 3; 
            else nextFruitIndex = Math.floor(Math.random() * 5);

            const info = FRUITS[nextFruitIndex];
            const size = info.radius * 2 * 0.45; 
            preview.style.width = size + 'px'; preview.style.height = size + 'px';

            if (blindNextCount > 0) {
                preview.style.backgroundImage = 'none';
                preview.style.backgroundColor = '#ddd';
                preview.innerText = '?';
            } else {
                const bgImg = info.optimizedImg || info.img;
                preview.style.backgroundImage = `url('${bgImg}')`;
                preview.style.backgroundColor = '#fff'; 
                preview.innerText = '';
            }
        }

        function handleCollisions(event) {
            event.pairs.forEach(pair => {
                const { bodyA, bodyB } = pair;
                if (bodyA.label.startsWith('fruit_') && bodyA.label === bodyB.label) {
                    const index = parseInt(bodyA.label.split('_')[1]);
                    if (bodyA.isProcessed || bodyB.isProcessed || index === FRUITS.length - 1) return;
                    bodyA.isProcessed = bodyB.isProcessed = true;
                    World.remove(engine.world, [bodyA, bodyB]);
                    
                    // üîä Ìï©Ï≥êÏßà Îïå ÏÜåÎ¶¨ Ïû¨ÏÉù
                    playSound('pop');

                    createFruit((bodyA.position.x + bodyB.position.x)/2, (bodyA.position.y + bodyB.position.y)/2, index + 1);
                    score += Math.floor(FRUITS[index].score * 2 * scoreMultiplier);
                    updateScore();
                    checkLuckyCard();
                }
            });
        }
        function updateScore() { document.getElementById('score-text').innerText = score; }

        let pendingEffect = null;
        function checkLuckyCard() {
            if (currentMode === 'vanilla') return;
            if (score - lastCardScore >= CARD_THRESHOLD) {
                lastCardScore = score; canDrop = false; setTimeout(showLuckyCard, 500);
            }
        }

        function showLuckyCard() {
            const cardScreen = document.getElementById('card-screen');
            const activeCard = document.getElementById('active-card');
            const title = document.getElementById('card-title');
            const desc = document.getElementById('card-desc');
            activeCard.className = 'jelly-card ' + (currentMode === 'easy' ? 'card-easy' : 'card-hard');
            cardScreen.classList.remove('hidden');
            void activeCard.offsetWidth;
            
            if (currentMode === 'easy') {
                title.innerText = "‚ú® ÏóòÏßÑÍµ≠Ïùò ÏÑ†Î¨º ‚ú®"; title.style.color = "#4ECDC4";
                const effects = [
                    {t:"clear_small",d:"ÏÇ¨Ïû• ÎÇòÏôÄÏûá! (ÏûëÏùÄ Í±∞ ÏÇ≠Ï†ú)"},
                    {t:"remove_random",d:"Ïπ¥Î°† Ïú†ÎãàÎ≤ÑÏä§ ÎûúÎç§ 1Î™Ö Î∞©Ï∂ú"},
                    {t:"score_buff",d:"Ïó¨Îü¨Î∂Ñ ÏãùÏÇ¨Îäî ÌïòÏÖ®ÎÇòÏöî? (Ï†êÏàò Î≤ÑÌîÑ)"},
                    {t:"double_score",d:"ÌäπÎ≥ÑÌïú Ïπ¥ÎãàÎãàÍ∞Ä ÏôîÏñ¥ (Ï†êÏàò 2Î∞∞)"},
                    {t:"all_cherry",d:"Ï†¨Îßà ÏôÄÏ™ÑÏóº (Î™®Îëê Ï†¨ÎßàÎ°ú)"},
                    {t:"fixed_spawn",d:"Ïò®ÏÑ∏ÏÉÅÏù¥ ÏóòÎ¶¨Îã§ (10ÌÑ¥ 3Î≤à Í≥†Ï†ï)"},
                    {t:"level_up",d:"ÌîºÏπ¥Ï∏Ñ Ï≤úÎë•ÏùòÎèåÏù¥Ïïº (ÎûúÎç§ Í≥ºÏùº 1Îã®Í≥Ñ ÏÉÅÏäπ)"}, 
                    {t:"low_gravity",d:"Î≥¥Îùº Í±∞Ï£Ω ÌíçÏÑ† (5ÌÑ¥ ÎèôÏïà Îë•Ïã§Îë•Ïã§)"},
                    {t:"explosion",d:"ÎÇòÏó¨ Ïã†Ïπ¥Î¶∞ (Í≥µÍ∞Ñ ÌôïÎ≥¥)"},
                    {t:"lift_up",d:"ÌÖêÏÖò ÎÅåÏñ¥ Ïò¨~Î†π!(ÎßàÏßÄÎßâ Í≥ºÏùº Îì§Ïñ¥Ïò¨Î¶º)"}
                ];
                const sel = effects[Math.floor(Math.random()*effects.length)];
                desc.innerText = sel.d; pendingEffect = sel.t;
            } else {
                title.innerText = "üëø ÏïÑÎ¶¨ÏÇ¨Ïùò Ïû•ÎÇú üëø"; title.style.color = "#FF6B81";
                const effects = [
                    {t:"spawn_bomb",d:"Ïò§Ìã∞ÌöΩÏù¥Ïïº!!! (ÎûúÎç§ Í≥ºÏùº 5Í∞ú Ìà¨Ìïò)"},
                    {t:"earthquake",d:"ÏñÑÎ£®Îù† (ÏßÄÏßÑ)"},
                    {t:"score_tax",d:"ÏπòÏßÄÏßÅ Ïò¨Ìï¥Ïùò ÏàòÍ∏àÏôï (Ï†êÏàò -100)"},
                    {t:"blind_field",d:"ÎààÏóêÎã§Î†àÎÅºÍ∞ÄÍ≤ÅÎÇòÌÅ¨Í≤åÎÇ´Îî∞. Îëê. (10ÌÑ¥ ÏïàÎ≥¥ÏûÑ)"},
                    {t:"blind_next",d:"Ìå°Ïù¥Ïïº ÎÇò.Îßå.Î¥ê. (10ÌÑ¥ Îã§Ïùå Î™®Î¶Ñ)"},
                    {t:"spin_cycle",d:"Î°§ÎßÅÍ∑∏ (Î™®Îëê ÌöåÏ†Ñ)"}, 
                    {t:"level_down",d:"ÏùºÎ£®ÏôÄÏûâ! (ÎûúÎç§ Í≥ºÏùº 1Îã®Í≥Ñ ÌïòÎùΩ)"},
                    {t:"freeze_mode",d:"ÎπôÌïòÍ∏∞Í∞Ä ÏôÄÏç®Ïù¥ (5ÌÑ¥ ÎèôÏïà ÎªëÎªëÌï¥Ïßê)"},
                    {t:"ghost_mode",d:"Ìï©Î∞©Ïùò ÏïÑÎ¶¨ÏÇ¨Î•º ÏïÑÎäîÏÇ¨Îûå: „Ñ±- (5ÌÑ¥ ÎèôÏïà ÌÜµÍ≥ºÎê®)"}
                ];
                const sel = effects[Math.floor(Math.random()*effects.length)];
                desc.innerText = sel.d; pendingEffect = sel.t;
            }
        }

        function applyCardEffect() {
            document.getElementById('card-screen').classList.add('hidden');
            const bodies = Composite.allBodies(engine.world).filter(b => b.label.startsWith('fruit_'));
            
            if (pendingEffect === "clear_small") { bodies.forEach(b => { if (b.label === 'fruit_0') World.remove(engine.world, b); }); } 
            else if (pendingEffect === "remove_random" && bodies.length) { World.remove(engine.world, bodies[Math.floor(Math.random()*bodies.length)]); }
            else if (pendingEffect === "earthquake") { bodies.forEach(b => Body.applyForce(b, b.position, {x:(Math.random()-0.5)*0.2, y:-0.1})); }
            else if (pendingEffect === "spin_cycle") { bodies.forEach(b => Body.setAngularVelocity(b, Math.random() - 0.5)); }
            
            else if (pendingEffect === "score_buff") scoreMultiplier += 0.5;
            else if (pendingEffect === "double_score") { score *= 2; updateScore(); }
            else if (pendingEffect === "all_cherry") { bodies.forEach(b => { const x = b.position.x; const y = b.position.y; World.remove(engine.world, b); createFruit(x, y, 0); }); }
            else if (pendingEffect === "fixed_spawn") { fixedSpawnCount = 10; setNextFruit(); }
            else if (pendingEffect === "level_up" && bodies.length > 0) {
                const upgradable = bodies.filter(b => parseInt(b.label.split('_')[1]) < FRUITS.length - 1);
                if(upgradable.length > 0) {
                    const target = upgradable[Math.floor(Math.random() * upgradable.length)];
                    const idx = parseInt(target.label.split('_')[1]);
                    World.remove(engine.world, target); createFruit(target.position.x, target.position.y, idx + 1);
                }
            }
            else if (pendingEffect === "low_gravity") { lowGravityCount = 5; engine.world.gravity.y = 0.8; }
            else if (pendingEffect === "explosion") {
                const centerX = WIDTH / 2; const centerY = HEIGHT / 2;
                bodies.forEach(b => {
                    const dx = b.position.x - centerX; const dy = b.position.y - centerY;
                    const forceMag = 0.05; 
                    Body.applyForce(b, b.position, { x: Math.sign(dx)*forceMag, y: Math.sign(dy)*forceMag - 0.05 });
                });
            }
            else if (pendingEffect === "lift_up" && bodies.length > 0) {
                const target = bodies[Math.floor(Math.random()*bodies.length)];
                Body.setPosition(target, { x: target.position.x, y: 50 }); 
                Body.setVelocity(target, { x: 0, y: 0 }); 
            }

            else if (pendingEffect === "score_tax") { score = Math.max(0, score - 100); updateScore(); }
            else if (pendingEffect === "blind_field") { blindFieldCount = 10; document.getElementById('blind-layer').classList.add('blind-active'); }
            else if (pendingEffect === "blind_next") { blindNextCount = 10; setNextFruit(); }
            else if (pendingEffect === "spawn_bomb") {
                for(let i=0; i<5; i++) { setTimeout(() => { createFruit(50 + Math.random()*(WIDTH-100), 0, Math.floor(Math.random()*5)); }, i * 200); }
            }
            else if (pendingEffect === "level_down" && bodies.length > 0) {
                const downgradable = bodies.filter(b => parseInt(b.label.split('_')[1]) > 0);
                if(downgradable.length > 0) {
                    const target = downgradable[Math.floor(Math.random() * downgradable.length)];
                    const idx = parseInt(target.label.split('_')[1]);
                    World.remove(engine.world, target); createFruit(target.position.x, target.position.y, idx - 1);
                }
            }
            else if (pendingEffect === "freeze_mode") {
                freezeCount = 5; 
                document.getElementById('freeze-layer').classList.add('freeze-active');
                bodies.forEach(b => { b.friction = 1.0; b.frictionStatic = 10.0; b.restitution = 0.0; });
            }
            else if (pendingEffect === "ghost_mode") { ghostCount = 5; }

            pendingEffect = null; canDrop = true;
        }

        function checkGameOverLogic() {
            if (isGameOver) return;
            const bodies = Composite.allBodies(engine.world);
            for (const body of bodies) {
                if ((body.label.startsWith('fruit_') || body.label === 'rock') && !body.isStatic) {
                    if (body.position.y < 100 && body.speed < 0.15 && body.position.y > 0) {
                        gameOver(); break;
                    }
                }
            }
        }
        function gameOver() {
            isGameOver = true; Runner.stop(runner);
            let modeText = "";
            if (currentMode === 'easy') modeText = "Ïù¥ÏßÄ Î™®Îìú";
            else if (currentMode === 'hard') modeText = "ÎØøÌûå Í∞úÏ≥ê Ïñ¥Î†§ÏõÄ";
            else modeText = "Ïò§Î¶¨ÏßÄÎÑê";
            document.getElementById('final-mode').innerText = modeText;
            document.getElementById('final-score').innerText = score + "Ï†ê";
            document.getElementById('game-over-screen').classList.remove('hidden');
        }
    </script>
</body>
</html>